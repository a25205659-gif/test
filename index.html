<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…¸é¹¼æ€§æª¢æ¸¬å°éŠæˆ²</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Firebase CDN (ç”¨æ–¼è³‡æ–™åº«å’Œèº«ä»½é©—è­‰) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ä¿æŒç¾ä»£æ„Ÿï¼Œä¸¦è¨­ç½®èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* æ·ºè—ç°è‰²èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* éŠæˆ²å¡ç‰‡æ¨£å¼ */
        #game-container {
            max-width: 480px;
            width: 100%;
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem; /* æ›´åœ“æ½¤çš„é‚Šè§’ */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .game-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
            width: 48%; /* ç¢ºä¿å…©å€‹æŒ‰éˆ•ä¸¦æ’ */
        }
        .game-button:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        /* è‡ªå®šç¾©æŒ‰éˆ•é™°å½±å’Œé¡è‰² */
        #acid-btn {
            background-color: #ef4444; /* ç´…è‰²ï¼Œä»£è¡¨é…¸ */
            color: white;
            box-shadow: 0 4px #dc2626;
        }
        #base-btn {
            background-color: #3b82f6; /* è—è‰²ï¼Œä»£è¡¨é¹¼ */
            color: white;
            box-shadow: 0 4px #2563eb;
        }

        /* åé¥‹è¨Šæ¯å‹•ç•« */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        #feedback-message {
            animation: fade-in-up 0.5s ease-out;
        }
    </style>
</head>
<body>

<div id="game-container">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6">
        ğŸ§ª é…¸é¹¼æ€§å¤§æŒ‘æˆ°
    </h1>

    <!-- åˆ†æ•¸é¡¯ç¤ºå€ -->
    <div class="flex justify-between items-center bg-yellow-100 p-4 rounded-xl mb-8 border border-yellow-300">
        <span class="text-xl font-medium text-yellow-800">ç¸½é‡‘å¹£ï¼š</span>
        <span id="score" class="text-3xl font-bold text-yellow-600">0</span>
    </div>
    
    <!-- Firebase Status -->
    <div id="firebase-status" class="text-xs text-center text-gray-500 mb-4">
        é€£ç·šä¸­...
    </div>

    <!-- 1. å§“åè¼¸å…¥å€ (Game Setup) -->
    <div id="name-input-section" class="transition-opacity opacity-0 pointer-events-none p-6 rounded-xl bg-gray-50 mb-8 shadow-inner">
        <p class="text-xl font-semibold text-indigo-700 mb-4">è«‹è¼¸å…¥æ‚¨çš„åç¨±ï¼š</p>
        <input type="text" id="player-name-input" maxlength="15" placeholder="è¼¸å…¥åç¨± (æœ€å¤š15å­—)" class="w-full p-3 mb-4 border-2 border-indigo-300 rounded-lg text-lg text-center focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button id="start-game-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors">
            é–‹å§‹ 10 é¡Œæ¸¬é©—
        </button>
        <button id="view-leaderboard-btn" class="w-full mt-2 py-2 bg-gray-400 text-white font-bold rounded-xl hover:bg-gray-500 transition-colors">
            æŸ¥çœ‹æ’è¡Œæ¦œ
        </button>
    </div>

    <!-- 2. éŠæˆ²é€²è¡Œå€ (Question) -->
    <div id="quiz-section" class="hidden">
        <!-- å•é¡Œè¨ˆæ•¸å™¨ -->
        <div id="question-counter" class="text-lg font-semibold text-indigo-600 mb-4">
            ç¬¬ 0 é¡Œ / å…± 10 é¡Œ
        </div>

        <div class="bg-indigo-50 p-6 rounded-xl mb-8 shadow-inner">
            <p class="text-lg text-gray-600 mb-3">è«‹åˆ¤æ–·ä»¥ä¸‹æ°´æº¶æ¶²çš„é…¸é¹¼æ€§ï¼š</p>
            
            <!-- Image display area -->
            <div id="question-display" class="mb-4 flex justify-center">
                <img id="solution-image" src="" alt="æ°´æº¶æ¶²åœ–ç‰‡" class="w-40 h-40 mx-auto rounded-xl shadow-lg border-2 border-indigo-200 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/160x160/CCCCCC/333333?text=Image';" >
            </div>

            <!-- Text label for the name of the solution -->
            <div id="solution-name-label" class="text-3xl font-black text-indigo-700 h-10 flex items-center justify-center">
                è¼‰å…¥ä¸­...
            </div>
        </div>

        <!-- é¸é …æŒ‰éˆ•å€ -->
        <div id="button-area" class="flex justify-between space-x-4 mb-6">
            <button id="acid-btn" class="game-button" data-type="é…¸æ€§">
                <span role="img" aria-label="Acid">ğŸ</span> é…¸æ€§
            </button>
            <button id="base-btn" class="game-button" data-type="é¹¼æ€§">
                <span role="img" aria-label="Base">ğŸ§¼</span> é¹¼æ€§
            </button>
        </div>

        <!-- åé¥‹è¨Šæ¯å€ -->
        <div id="feedback-container" class="h-10">
            <!-- ç­”å°æˆ–ç­”éŒ¯çš„è¨Šæ¯æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>
        
        <!-- ä¸‹ä¸€é¡Œ / å®Œæˆæ¸¬é©— æŒ‰éˆ• -->
        <button id="next-question-btn" class="w-full mt-4 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition-colors hidden" onclick="loadNextQuestion()">
            ä¸‹ä¸€é¡Œ
        </button>

        <!-- çµæŸéŠæˆ²æŒ‰éˆ• (åœ¨å›ºå®š 10 é¡Œæ¨¡å¼ä¸‹ï¼Œé€™å€‹æŒ‰éˆ•æœƒè¢«éš±è—ï¼Œæµç¨‹çµæŸè‡ªå‹•æäº¤) -->
        <button id="end-game-btn" class="w-full mt-2 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors hidden">
            çµæŸä¸¦æäº¤åˆ†æ•¸
        </button>
    </div>


    <!-- 3. æ’è¡Œæ¦œå€ (Leaderboard) -->
    <div id="leaderboard-section" class="hidden">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6">ğŸ† æ’è¡Œæ¦œ</h2>
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <div class="flex font-bold text-sm text-gray-600 border-b p-3 bg-gray-100">
                <span class="w-1/6 text-left">#</span>
                <span class="w-3/6 text-left">åç¨±</span> <!-- ç§»é™¤ User ID é¡¯ç¤º -->
                <span class="w-2/6 text-right">é‡‘å¹£</span>
            </div>
            <ul id="leaderboard-list" class="divide-y divide-gray-100 min-h-[150px]">
                <!-- æ’è¡Œæ¦œé …ç›®å°‡æ’å…¥æ­¤è™• -->
                <li class="p-4 text-center text-gray-500">è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
        <button id="back-to-menu-btn" class="w-full mt-4 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors">
            è¿”å›ä¸»é¸å–®
        </button>
    </div>
</div>

<script>
    // éŠæˆ²æ•¸æ“šï¼šæ°´æº¶æ¶²åç¨±ã€æ­£ç¢ºçš„é…¸é¹¼æ€§ï¼Œä»¥åŠåœ–ç‰‡ URL
    const solutions = [
        { name: "æª¸æª¬æ±", type: "é…¸æ€§", img: "https://placehold.co/160x160/FFF38F/D97706?text=Lemon+Slice" }, 
        { name: "è‚¥çš‚æ°´", type: "é¹¼æ€§", img: "https://placehold.co/160x160/B3E5FC/01579B?text=Soap+Bubbles" }, 
        { name: "èƒƒé…¸", type: "é…¸æ€§", img: "https://placehold.co/160x160/C62828/FFFFFF?text=Gastric+Fluid" }, 
        { name: "æ¼‚ç™½æ°´", type: "é¹¼æ€§", img: "https://placehold.co/160x160/FFEB3B/212121?text=Cleaner" }, 
        { name: "é†‹", type: "é…¸æ€§", img: "https://placehold.co/160x160/9C7C3B/FFFFFF?text=Vinegar+Bottle" }, 
        { name: "å°è˜‡æ‰“æ°´", type: "é¹¼æ€§", img: "https://placehold.co/160x160/F5F5F5/424242?text=Baking+Powder" }, 
        { name: "å’–å•¡", type: "é…¸æ€§", img: "https://placehold.co/160x160/4E342E/FFFFFF?text=Coffee+Cup" }, 
        { name: "æ°¨æ°´", type: "é¹¼æ€§", img: "https://placehold.co/160x160/64DD17/FFFFFF?text=Ammonia" }, 
        { name: "ç•ªèŒ„æ±", type: "é…¸æ€§", img: "https://placehold.co/160x160/E53935/FFFFFF?text=Tomato" }, 
        { name: "å¯æ¨‚", type: "é…¸æ€§", img: "https://placehold.co/160x160/212121/BDBDBD?text=Fizzy+Cola" }, 
    ];

    // --- éŠæˆ²ç‹€æ…‹è®Šé‡ ---
    const MAX_QUESTIONS = 10;
    let currentScore = 0;
    let questionPool = []; // äº‚æ•¸æ’åºå¾Œçš„é¡Œåº«
    let currentQuestionIndex = 0; // 0-indexedï¼Œè¡¨ç¤ºä¸‹ä¸€é¡Œè¦è¼‰å…¥çš„ç´¢å¼•
    let isAnswered = false;

    // --- DOM Elements ---
    const scoreDisplay = document.getElementById('score');
    const solutionImage = document.getElementById('solution-image');
    const solutionNameLabel = document.getElementById('solution-name-label');
    const feedbackContainer = document.getElementById('feedback-container');
    const acidBtn = document.getElementById('acid-btn');
    const baseBtn = document.getElementById('base-btn');
    const nextBtn = document.getElementById('next-question-btn');
    const startGameBtn = document.getElementById('start-game-btn');
    const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const nameInput = document.getElementById('player-name-input');
    const nameInputSection = document.getElementById('name-input-section');
    const quizSection = document.getElementById('quiz-section');
    const leaderboardSection = document.getElementById('leaderboard-section');
    const leaderboardList = document.getElementById('leaderboard-list');
    const buttonArea = document.getElementById('button-area');
    const questionCounter = document.getElementById('question-counter');
    const buttons = [acidBtn, baseBtn];

    // --- Firebase Global Vars ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth;
    let userId = 'anonymous'; // å…§éƒ¨è®Šé‡ï¼Œç”¨æ–¼è³‡æ–™åº«æ“ä½œå’Œç•¶å‰ç©å®¶é«˜äº®

    // --- Utility Functions ---

    /**
     * Fisher-Yates äº‚æ•¸æ´—ç‰Œç®—æ³•
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    /**
     * é¡¯ç¤ºåé¥‹è¨Šæ¯ï¼Œä¸¦åœ¨å¹¾ç§’å¾Œè‡ªå‹•æ¸…é™¤ã€‚
     */
    function showFeedback(message, bgColorClass) {
        feedbackContainer.innerHTML = `<div id="feedback-message" class="p-2 rounded-xl text-white font-bold ${bgColorClass}">${message}</div>`;
        const msgElement = document.getElementById('feedback-message');
        if (msgElement) {
             msgElement.style.animation = 'none';
             msgElement.offsetHeight; 
             msgElement.style.animation = null;
        }

        setTimeout(() => {
            if (feedbackContainer.contains(msgElement)) {
                feedbackContainer.innerHTML = '';
            }
        }, 3000);
    }

    /**
     * æ›´æ–°åˆ†æ•¸é¡¯ç¤ºã€‚
     */
    function updateScoreDisplay() {
        scoreDisplay.textContent = currentScore;
    }

    /**
     * ç¦ç”¨æˆ–å•Ÿç”¨é¸æ“‡æŒ‰éˆ•ã€‚
     */
    function toggleAnswerButtons(disable) {
        buttons.forEach(btn => {
            btn.disabled = disable;
            btn.classList.toggle('opacity-50', disable);
            btn.classList.toggle('hover:opacity-100', !disable);
            btn.classList.toggle('cursor-not-allowed', disable);
        });
    }

    function showSection(sectionId) {
        nameInputSection.classList.add('hidden');
        quizSection.classList.add('hidden');
        leaderboardSection.classList.add('hidden');

        document.getElementById(sectionId).classList.remove('hidden');
    }

    // --- Firebase Initialization and Auth ---

    async function initializeFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            document.getElementById('firebase-status').textContent = 'âŒ è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—ï¼šç¼ºå°‘é…ç½®ã€‚';
            return;
        }

        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();

            // è¨­å®šåµéŒ¯ç­‰ç´š
            firebase.firestore.setLogLevel('debug');

            // è™•ç†èº«ä»½é©—è­‰
            if (initialAuthToken) {
                await auth.signInWithCustomToken(initialAuthToken);
            } else {
                await auth.signInAnonymously();
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    userId = user.uid;
                    // ç§»é™¤ User ID é¡¯ç¤ºï¼Œåªé¡¯ç¤ºé€£ç·šç‹€æ…‹
                    document.getElementById('firebase-status').textContent = 'âœ… è³‡æ–™åº«å·²é€£ç·š';
                    loadLeaderboard();
                } else {
                    document.getElementById('firebase-status').textContent = 'âŒ èº«ä»½é©—è­‰å¤±æ•—ã€‚';
                }
                // èº«ä»½é©—è­‰å®Œæˆå¾Œæ‰é¡¯ç¤ºè¼¸å…¥å€
                nameInputSection.classList.remove('opacity-0', 'pointer-events-none');
            });

        } catch (error) {
            console.error("Firebase initialization or auth failed:", error);
            document.getElementById('firebase-status').textContent = `âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—: ${error.message}`;
        }
    }

    // --- Firestore Functions ---

    /**
     * å„²å­˜ç©å®¶åˆ†æ•¸åˆ° Firestore æ’è¡Œæ¦œã€‚
     */
    async function saveScore(playerName, score) {
        // åªæœ‰åˆ†æ•¸å¤§æ–¼ 0 æ‰å„²å­˜
        if (!db) {
             showFeedback('âŒ è³‡æ–™åº«æœªé€£ç·šï¼Œåˆ†æ•¸ç„¡æ³•æäº¤ï¼', 'bg-red-500');
            return;
        }
        
        // ç¢ºä¿è‡³å°‘ç­”å° 1 é¡Œæ‰ç´€éŒ„ï¼Œé¿å…çŒæ°´
        if (score === 0) {
            showFeedback('ğŸ“ åˆ†æ•¸ç‚º 0ï¼Œä¸äºˆè¨˜éŒ„è‡³æ’è¡Œæ¦œã€‚', 'bg-gray-500');
            return;
        }

        // Collection path MUST be /artifacts/{appId}/public/data/leaderboard
        const collectionPath = `artifacts/${appId}/public/data/leaderboard`;
        const scoreData = {
            name: playerName || 'åŒ¿åç©å®¶',
            score: score,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            // å¿…é ˆä¿ç•™ userId ä»¥ç¬¦åˆ Firestore å®‰å…¨è¦å‰‡å’Œç•¶å‰ç©å®¶é«˜äº®éœ€æ±‚
            userId: userId, 
        };

        try {
            await db.collection(collectionPath).add(scoreData);
            showFeedback('âœ… åˆ†æ•¸æäº¤æˆåŠŸï¼', 'bg-green-500');
        } catch (e) {
            console.error("Error saving score: ", e);
            showFeedback('âŒ åˆ†æ•¸æäº¤å¤±æ•—ï¼è«‹æª¢æŸ¥é€£ç·šã€‚', 'bg-red-500');
        }
    }

    /**
     * å¾ Firestore è¼‰å…¥æ’è¡Œæ¦œä¸¦é¡¯ç¤ºã€‚
     */
    async function loadLeaderboard() {
        if (!db) {
            leaderboardList.innerHTML = '<li class="p-4 text-center text-red-500">è³‡æ–™åº«é€£ç·šéŒ¯èª¤ã€‚</li>';
            return;
        }
        leaderboardList.innerHTML = '<li class="p-4 text-center text-gray-500">è¼‰å…¥ä¸­...</li>';

        // Collection path MUST be /artifacts/{appId}/public/data/leaderboard
        const collectionPath = `artifacts/${appId}/public/data/leaderboard`;

        try {
            // ä½¿ç”¨ onSnapshot ç›£è½å³æ™‚è®ŠåŒ–
            db.collection(collectionPath)
              .limit(10) 
              .onSnapshot(snapshot => {
                let scores = [];
                snapshot.forEach(doc => {
                    scores.push(doc.data());
                });

                // æ ¹æ“šåˆ†æ•¸åœ¨è¨˜æ†¶é«”ä¸­æ’åº (é¿å… Firestore ç´¢å¼•å•é¡Œ)
                scores.sort((a, b) => b.score - a.score);

                leaderboardList.innerHTML = ''; // æ¸…é™¤èˆŠæ¸…å–®

                if (scores.length === 0) {
                    leaderboardList.innerHTML = '<li class="p-4 text-center text-gray-500">ç›®å‰æ²’æœ‰åˆ†æ•¸ç´€éŒ„ã€‚</li>';
                    return;
                }

                scores.forEach((data, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 hover:bg-indigo-50 transition-colors';
                    // æ ¹æ“š userId é«˜äº®ç•¶å‰ç”¨æˆ¶çš„ç´€éŒ„
                    if (data.userId === userId) {
                        li.classList.add('bg-yellow-100', 'font-bold', 'border-l-4', 'border-yellow-500');
                    }
                    
                    li.innerHTML = `
                        <span class="w-1/6 text-left font-mono text-xl">${index + 1}</span>
                        <span class="w-3/6 text-left truncate text-gray-800">${data.name}</span>
                        <span class="w-2/6 text-right text-3xl font-extrabold text-yellow-600">${data.score}</span>
                    `;
                    leaderboardList.appendChild(li);
                });
            }, error => {
                console.error("Error fetching leaderboard: ", error);
                leaderboardList.innerHTML = '<li class="p-4 text-center text-red-500">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—ã€‚</li>';
            });

        } catch (e) {
            console.error("Error initiating leaderboard listener: ", e);
            leaderboardList.innerHTML = '<li class="p-4 text-center text-red-500">åˆå§‹åŒ–æ’è¡Œæ¦œå¤±æ•—ã€‚</li>';
        }
    }

    // --- Game Flow Functions ---

    /**
     * è¼‰å…¥ä¸‹ä¸€é“é¡Œç›®ï¼Œå¦‚æœé¡Œç›®å·²æ»¿å‰‡çµæŸéŠæˆ²ã€‚
     */
    function loadNextQuestion() {
        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰é¡Œç›®
        if (currentQuestionIndex >= MAX_QUESTIONS) {
            endGame();
            return;
        }
        
        // é‡è¨­ç‹€æ…‹
        isAnswered = false;
        feedbackContainer.innerHTML = '';
        
        toggleAnswerButtons(false); // å•Ÿç”¨ä½œç­”æŒ‰éˆ•
        nextBtn.classList.add('hidden'); // éš±è—ä¸‹ä¸€é¡ŒæŒ‰éˆ•
        buttonArea.classList.remove('hidden'); 

        // è¼‰å…¥ç•¶å‰ç´¢å¼•çš„é¡Œç›®
        currentQuestion = questionPool[currentQuestionIndex];

        // æ›´æ–° UI
        // é¡Œæ•¸é¡¯ç¤ºæ˜¯ 1-indexed
        questionCounter.textContent = `ç¬¬ ${currentQuestionIndex + 1} é¡Œ / å…± ${MAX_QUESTIONS} é¡Œ`; 
        solutionNameLabel.textContent = currentQuestion.name; 
        solutionImage.src = currentQuestion.img; 
        solutionImage.alt = `åœ–ç‰‡ï¼š${currentQuestion.name}`;
        
        // æº–å‚™ä¸‹ä¸€é¡Œçš„ç´¢å¼•
        currentQuestionIndex++;
        
        // å¦‚æœä¸‹ä¸€é¡Œå°±æ˜¯æœ€å¾Œä¸€é¡Œï¼Œæ›´æ–°æŒ‰éˆ•æ–‡å­—
        if (currentQuestionIndex === MAX_QUESTIONS) {
            nextBtn.textContent = 'å®Œæˆæ¸¬é©—ä¸¦æäº¤åˆ†æ•¸';
            nextBtn.classList.remove('bg-green-500');
            nextBtn.classList.add('bg-red-500');
        } else {
             nextBtn.textContent = 'ä¸‹ä¸€é¡Œ';
             nextBtn.classList.add('bg-green-500');
             nextBtn.classList.remove('bg-red-500');
        }
    }

    /**
     * è™•ç†ç©å®¶çš„ç­”æ¡ˆé¸æ“‡ã€‚
     */
    function handleAnswer(event) {
        if (isAnswered) return; 

        isAnswered = true;
        toggleAnswerButtons(true); // ç¦ç”¨æŒ‰éˆ•
        nextBtn.classList.remove('hidden'); // é¡¯ç¤ºä¸‹ä¸€é¡Œ/å®ŒæˆæŒ‰éˆ•

        const selectedType = event.currentTarget.getAttribute('data-type');
        const correctAnswer = currentQuestion.type;
        const isCorrect = (selectedType === correctAnswer);

        if (isCorrect) {
            currentScore += 100; // ç­”å°åŠ åˆ†
            updateScoreDisplay();
            showFeedback(`âœ… ç­”å°äº†ï¼æ­å–œç²å¾— +100 é‡‘å¹£ï¼`, 'bg-green-500');
            event.currentTarget.classList.add('ring-4', 'ring-green-400');
        } else {
            // ç­”éŒ¯ä¸æ‰£åˆ†
            showFeedback(`âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctAnswer}ã€‚`, 'bg-red-500');
            event.currentTarget.classList.add('ring-4', 'ring-red-400');
            const correctBtn = document.querySelector(`[data-type="${correctAnswer}"]`);
            if (correctBtn) {
                correctBtn.classList.add('ring-4', 'ring-green-400');
            }
        }
        
        setTimeout(() => {
            buttons.forEach(btn => btn.classList.remove('ring-4', 'ring-green-400', 'ring-red-400'));
        }, 2000);
    }
    
    /**
     * å•Ÿå‹•éŠæˆ²ã€‚
     */
    function startGame() {
        const playerName = nameInput.value.trim() || 'åŒ¿åç©å®¶';
        if (playerName.length > 15) {
             showFeedback('âŒ åç¨±å¤ªé•·ï¼Œè«‹å°æ–¼15å€‹å­—ã€‚', 'bg-red-500');
             return;
        }
        if (solutions.length < MAX_QUESTIONS) {
            console.error("é¡Œåº«æ•¸é‡ä¸è¶³ 10 é¡Œã€‚");
            showFeedback('âŒ éŠæˆ²éŒ¯èª¤ï¼šé¡Œåº«æ•¸é‡ä¸è¶³ã€‚', 'bg-red-500');
            return;
        }

        // é–å®šåç¨±è¼¸å…¥ï¼Œæº–å‚™éŠæˆ²
        nameInput.disabled = true; 
        currentScore = 0;
        currentQuestionIndex = 0;
        questionPool = shuffleArray([...solutions]); // äº‚æ•¸æ´—ç‰Œä¸¦è¤‡è£½é¡Œåº«
        
        updateScoreDisplay();
        showSection('quiz-section');
        loadNextQuestion();
    }
    
    /**
     * çµæŸéŠæˆ²ä¸¦æäº¤åˆ†æ•¸ã€‚
     */
    function endGame() {
        const playerName = nameInput.value.trim() || 'åŒ¿åç©å®¶';
        saveScore(playerName, currentScore); // æäº¤åˆ†æ•¸
        nameInput.disabled = false; // è§£é–åç¨±è¼¸å…¥
        showSection('leaderboard-section'); // è·³è½‰åˆ°æ’è¡Œæ¦œ
        // é‡è¨­ä¸‹ä¸€é¡ŒæŒ‰éˆ•ç‚ºé è¨­ç‹€æ…‹
        nextBtn.textContent = 'ä¸‹ä¸€é¡Œ';
        nextBtn.classList.add('bg-green-500');
        nextBtn.classList.remove('bg-red-500');
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        updateScoreDisplay();
        
        // è¨­å®šåˆå§‹æ­¡è¿ç•«é¢
        solutionImage.src = "https://placehold.co/160x160/1E3A8A/BFDBFE?text=Chemistry+Quiz";
        solutionImage.alt = "æ­¡è¿åƒåŠ åŒ–å­¸æ¸¬é©—";
        solutionNameLabel.textContent = "æº–å‚™å¥½äº†å—ï¼Ÿ";
        questionCounter.textContent = `ç¬¬ 0 é¡Œ / å…± ${MAX_QUESTIONS} é¡Œ`;

        // ç¶å®šäº‹ä»¶
        startGameBtn.addEventListener('click', startGame);
        
        viewLeaderboardBtn.addEventListener('click', () => {
            showSection('leaderboard-section');
        });
        
        backToMenuBtn.addEventListener('click', () => {
            showSection('name-input-section');
        });

        buttons.forEach(btn => {
            btn.addEventListener('click', handleAnswer);
        });
        
        // nextBtn ç¾åœ¨èª¿ç”¨ loadNextQuestionï¼Œè©²å‡½æ•¸å…§å«çµæŸæª¢æŸ¥
        nextBtn.onclick = loadNextQuestion; 

        // åˆå§‹ç‹€æ…‹: é¡¯ç¤ºåç¨±è¼¸å…¥å€
        showSection('name-input-section');
        
        // å•Ÿå‹• Firebase
        initializeFirebase();
    });
</script>

</body>
</html>